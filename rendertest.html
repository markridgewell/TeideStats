<!DOCTYPE html>
<html>

<body>
<!--Enter your token: <input type="password" id="token"/>
<input type="submit" value="Submit" />-->
<div id="div">
</div>

<script type="module">
import { Octokit } from "https://esm.sh/@octokit/core";

const params = new URLSearchParams(window.location.search);
const token = prompt("Enter your token:");

const octokit = new Octokit({
    auth: token
});

function elem(type, text) {
    var elem = document.createElement(type);
    elem.appendChild(text);
    return elem;
}

function p(text) {
    return elem('p', document.createTextNode(text));
}

function a(text, href) {
    const a = elem('a', document.createTextNode(text));
    a.href = href;
    return a;
}

async function getArtifacts(run_id) {
    const response = await octokit.request('GET /repos/{owner}/{repo}/actions/artifacts?per_page=100', {
        owner: 'markridgewell',
        repo: 'Teide',
        headers: {
            'X-GitHub-Api-Version': '2022-11-28'
        }
    })
    
    console.log(response);
    const runArtifacts = response.data.artifacts.filter(_ => _.workflow_run.id == run_id);
    console.log(runArtifacts);
    const div = document.getElementById("div");
    div.appendChild(p(`${runArtifacts.length} artifacts found`));
    const list = document.createElement('ol');
    for (const artifact of runArtifacts) {
        const link = elem('a', document.createTextNode(artifact.name));
        link.href = `rendertest_run.html?artifact_id=${artifact.id}&token=${token}`;
        list.appendChild(elem('li', link));
    }
    div.appendChild(list);
}

getArtifacts(params.get('run_id'));
</script>

</body>
</html>
